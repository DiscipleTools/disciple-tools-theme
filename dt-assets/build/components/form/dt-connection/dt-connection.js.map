{"version":3,"file":"dt-connection.js","sources":["../../../src/components/form/dt-connection/dt-connection.js"],"sourcesContent":["import { css, html } from 'lit';\nimport { DtTags } from '../dt-tags/dt-tags.js';\n\nexport class DtConnection extends DtTags {\n  static get styles() {\n    return [\n      ...super.styles,\n      css`\n        .selected-option a {\n          border-inline-start: solid 3px transparent;\n        }\n\n        li button * {\n          pointer-events: none;\n        }\n\n        li {\n          border-inline-start: solid 5px transparent;\n        }\n\n        li button .status {\n          font-style: italic;\n          opacity: 0.6;\n        }\n        li button .status:before {\n          content: '[';\n          font-style: normal;\n        }\n        li button .status:after {\n          content: ']';\n          font-style: normal;\n        }\n\n        li button svg {\n          width: 1.5em;\n          height: auto;\n          margin-bottom: -.25em;\n        }\n        li button svg use {\n          fill: var(--dt-connection-icon-fill, var(--primary-color));\n        }\n      `,\n    ];\n  }\n\n  _clickOption(e) {\n    if (e.target && e.target.value) {\n      const id = parseInt(e.target.value, 10);\n      const option = this.filteredOptions.reduce((result, opt) => {\n        if (!result && opt.id == id) {\n          return opt;\n        }\n        return result;\n      }, null);\n      if (option) {\n        this._select(option);\n      }\n      this._clearSearch();\n    }\n  }\n\n  _clickAddNew(e) {\n    if (e.target) {\n      this._select({\n        id: e.target.dataset?.label,\n        label: e.target.dataset?.label,\n        isNew: true,\n      });\n      // clear search field if clicked with mouse, since field will lose focus\n      const input = this.shadowRoot.querySelector('input');\n      if (input) {\n        input.value = '';\n      }\n    }\n  }\n\n  _keyboardSelectOption() {\n    if (this.activeIndex > -1) {\n      if (this.activeIndex + 1 > this.filteredOptions.length) {\n        this._select({\n          id: this.query,\n          label: this.query,\n          isNew: true,\n        });\n      } else {\n        this._select(this.filteredOptions[this.activeIndex]);\n      }\n      this._clearSearch();\n    }\n  }\n\n  _remove(e) {\n    if (e.target && e.target.dataset && e.target.dataset.value) {\n      const event = new CustomEvent('change', {\n        detail: {\n          field: this.name,\n          oldValue: this.value,\n        },\n      });\n      this.value = (this.value || []).map(i => {\n        const val = {\n          ...i,\n        };\n        if (i.id === e.target.dataset.value) {\n          val.delete = true;\n        }\n        return val;\n      });\n      event.detail.newValue = this.value;\n\n      // dispatch event for use with addEventListener from javascript\n      this.dispatchEvent(event);\n\n      // If option was de-selected while list was open, re-focus input\n      if (this.open) {\n        this.shadowRoot.querySelector('input').focus();\n      }\n    }\n  }\n\n  /**\n   * Filter to options that:\n   *   1: are not selected\n   *   2: match the search query\n   * @private\n   */\n  _filterOptions() {\n    const selectedValues = (this.value || [])\n      .filter(i => !i.delete)\n      .map(v => v?.id);\n\n    if (this.options?.length) {\n      this.filteredOptions = (this.options || []).filter(\n        opt =>\n          !selectedValues.includes(opt.id) &&\n          (!this.query ||\n            opt.label\n              .toLocaleLowerCase()\n              .includes(this.query.toLocaleLowerCase()))\n      );\n    } else if (this.open || this.canUpdate) {\n      // Only run this filtering if the list is open.\n      // This prevents it from running on initial load before a `load` event is attached.\n      this.loading = true;\n      this.filteredOptions = [];\n\n      // need to fetch data via API request\n      const self = this;\n      const event = new CustomEvent('dt:get-data', {\n        bubbles: true,\n        detail: {\n          field: this.name,\n          postType: this.postType,\n          query: this.query,\n          onSuccess: result => {\n            self.loading = false;\n\n            // filter out selected values from list\n            self.filteredOptions = result.filter(\n              opt => !selectedValues.includes(opt.id)\n            );\n          },\n          onError: error => {\n            console.warn(error);\n            self.loading = false;\n            this.canUpdate = false;\n          },\n        },\n      });\n      this.dispatchEvent(event);\n    }\n    return this.filteredOptions;\n  }\n\n  _renderSelectedOptions() {\n    return (this.value || [])\n      .filter(i => !i.delete)\n      .map(\n        opt => html`\n          <div class=\"selected-option\">\n            <a\n              href=\"${opt.link}\"\n              style=\"border-inline-start-color: ${opt.status\n                ? opt.status.color\n                : ''}\"\n              ?disabled=\"${this.disabled}\"\n              title=\"${opt.status ? opt.status.label : opt.label}\"\n              >${opt.label}</a\n            >\n            <button\n              @click=\"${this._remove}\"\n              ?disabled=\"${this.disabled}\"\n              data-value=\"${opt.id}\"\n            >\n              x\n            </button>\n          </div>\n        `\n      );\n  }\n\n  _renderOption(opt, idx) {\n    // prettier-ignore\n    const svg = html`<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><title>circle-08 2</title><desc>Created using Figma</desc><g id=\"Canvas\" transform=\"translate(1457 4940)\"><g id=\"circle-08 2\"><g id=\"Group\"><g id=\"Vector\"><use xlink:href=\"#path0_fill\" transform=\"translate(-1457 -4940)\" fill=\"#000000\"/></g></g></g></g><defs><path id=\"path0_fill\" d=\"M 12 0C 5.383 0 0 5.383 0 12C 0 18.617 5.383 24 12 24C 18.617 24 24 18.617 24 12C 24 5.383 18.617 0 12 0ZM 8 10C 8 7.791 9.844 6 12 6C 14.156 6 16 7.791 16 10L 16 11C 16 13.209 14.156 15 12 15C 9.844 15 8 13.209 8 11L 8 10ZM 12 22C 9.567 22 7.335 21.124 5.599 19.674C 6.438 18.091 8.083 17 10 17L 14 17C 15.917 17 17.562 18.091 18.401 19.674C 16.665 21.124 14.433 22 12 22Z\"/></defs></svg>`\n\n    const status = opt.status || {\n      key: '',\n      label: '',\n      color: '',\n    };\n    return html`\n      <li tabindex=\"-1\" style=\"border-inline-start-color:${status.color}\">\n        <button\n          value=\"${opt.id}\"\n          type=\"button\"\n          data-label=\"${opt.label}\"\n          @click=\"${this._clickOption}\"\n          @touchstart=\"${this._touchStart}\"\n          @blur=\"${this._inputFocusOut}\"\n          @touchmove=\"${this._touchMove}\"\n          @touchend=\"${this._touchEnd}\"\n          tabindex=\"-1\"\n          class=\"${this.activeIndex > -1 && this.activeIndex === idx\n            ? 'active'\n            : ''}\"\n        >\n          <span class=\"label\">${opt.label}</span>\n          <span class=\"connection-id\">(#${opt.id})</span>\n          ${status.label\n            ? html`<span class=\"status\">${status.label}</span>`\n            : null}\n          ${opt.user ? svg : null}\n        </button>\n      </li>\n    `;\n  }\n}\n\nwindow.customElements.define('dt-connection', DtConnection);\n"],"names":["window","customElements","define","DtTags","styles","super","css","_clickOption","e","target","value","id","parseInt","option","this","filteredOptions","reduce","result","opt","_select","_clearSearch","_clickAddNew","dataset","label","isNew","input","shadowRoot","querySelector","_keyboardSelectOption","activeIndex","length","query","_remove","event","CustomEvent","detail","field","name","oldValue","map","i","val","delete","newValue","dispatchEvent","open","focus","_filterOptions","selectedValues","filter","v","options","includes","toLocaleLowerCase","canUpdate","loading","self","bubbles","postType","onSuccess","onError","error","console","warn","_renderSelectedOptions","html","link","status","color","disabled","_renderOption","idx","svg","key","_touchStart","_inputFocusOut","_touchMove","_touchEnd","user"],"mappings":"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"}