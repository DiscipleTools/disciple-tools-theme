import{i as t,y as e}from"../../lit-element-2409d5fe.js";import{m as i}from"../../lit-localize-763e4978.js";import{D as s}from"../dt-multi-select/dt-multi-select.js";import"../../style-map-ac85d91b.js";import"../../directive-de55b00a.js";import"../dt-form-base.js";import"../../dt-base.js";import"../dt-label/dt-label.js";import"../../icons/dt-spinner.js";import"../../icons/dt-checkmark.js";class l extends s{static get properties(){return{...super.properties,allowAdd:{type:Boolean},onload:{type:String}}}static get styles(){return[...super.styles,t`.selected-option a,.selected-option a:active,.selected-option a:visited{text-decoration:none;color:var(--primary-color,#3f729b)}`]}willUpdate(t){if(super.willUpdate(t),t){!t.has("open")||!this.open||this.filteredOptions&&this.filteredOptions.length||this._filterOptions()}}_clickOption(t){if(t.target&&t.target.value){const e=t.target.value,i=this.filteredOptions.reduce(((t,i)=>t||i.id!==e?t:i),null);this._select(i)}}_clickAddNew(t){t.target&&this._select({id:t.target.dataset?.label,label:t.target.dataset?.label,isNew:!0})}_remove(t){if(t.target&&t.target.dataset&&t.target.dataset.value){const e=new CustomEvent("change",{detail:{field:this.name,oldValue:this.value}});this.value=(this.value||[]).map((e=>{const i={...e};return e.id===t.target.dataset.value&&(i.delete=!0),i})),e.detail.newValue=this.value,this.dispatchEvent(e),this.open&&this.shadowRoot.querySelector("input").focus()}}_keyboardSelectOption(){this.activeIndex>-1&&(this.activeIndex+1>this.filteredOptions.length?this._select({id:this.query,label:this.query,isNew:!0}):this._select(this.filteredOptions[this.activeIndex]))}_listHighlightNext(){this.activeIndex=Math.min(this.filteredOptions.length,this.activeIndex+1)}_filterOptions(){const t=(this.value||[]).filter((t=>!t.delete)).map((t=>t?.id));if(this.options?.length)this.filteredOptions=(this.options||[]).filter((e=>!t.includes(e.id)&&(!this.query||e.label.toLocaleLowerCase().includes(this.query.toLocaleLowerCase()))));else if(this.open){this.loading=!0,this.filteredOptions=[];const e=this,i=new CustomEvent("load",{bubbles:!0,detail:{field:this.name,query:this.query,onSuccess:i=>{e.loading=!1,e.filteredOptions=i.filter((e=>!t.includes(e.id)))},onError:t=>{console.warn(t),e.loading=!1}}});this.dispatchEvent(i)}return this.filteredOptions}_renderOptions(){let t=super._renderOptions();return this.allowAdd&&this.query&&(Array.isArray(t)||(t=[t]),t.push(e`<li><button data-label="${this.query}" @click="${this._clickAddNew}" @touchstart="${this._touchStart}" @touchmove="${this._touchMove}" @touchend="${this._touchEnd}" class="${this.activeIndex>-1&&this.activeIndex>=this.filteredOptions.length?"active":""}">${i("Add")} "${this.query}"</button></li>`)),t}_renderSelectedOptions(){return(this.value||[]).filter((t=>!t.delete)).map((t=>{let i=t.link;if(!i&&window?.SHAREDFUNCTIONS?.createCustomFilter){const e=window.SHAREDFUNCTIONS.createCustomFilter(this.name,[t.label]),s=this.label||this.name,l=[{id:`${this.name}_${t.label}`,name:`${s}: ${t.label}`}];i=window.SHAREDFUNCTIONS.create_url_for_list_query(this.postType,e,l)}return e`<div class="selected-option"><a href="${i||"#"}" ?disabled="${this.disabled}" alt="${t.status?t.status.label:t.label}">${t.label}</a> <button @click="${this._remove}" ?disabled="${this.disabled}" data-value="${t.id}">x</button></div>`}))}}window.customElements.define("dt-tags",l);export{l as D};
