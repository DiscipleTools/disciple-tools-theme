# DT_Posts::get_post_activity() - Comprehensive Documentation

This document provides detailed information about the `get_post_activity()` method in the DT_Posts API, including its functionality, parameters, return structure, and examples for each field type.

## Method Signature

```php
DT_Posts::get_post_activity(
    string $post_type,           // The post type to retrieve activity for (e.g., 'contacts', 'groups')
    int $post_id,                // The ID of the post to retrieve activity for
    array $args = []             // Optional arguments for pagination and filtering
)
```

## Description

The `get_post_activity()` method retrieves the activity log for a specific post. It returns a comprehensive array containing all activity entries for the post, formatted with human-readable messages. The method handles permission checks and excludes hidden fields from the activity log.

## Parameters

### $args Array Options

```php
$args = [
    'offset' => 0,               // Number of records to skip (default: 0)
    'number' => 1000,            // Maximum number of records to return (default: 1000)
    'revert' => false            // Whether to return revert history format (default: false)
]
```

## Return Value

The method returns an associative array with two keys:

```php
[
    'activity' => [...],         // Array of activity objects
    'total' => 25               // Total number of activity records
]
```

Or a WP_Error object if the user doesn't have permission to view the post.

## Activity Object Structure

Each activity object in the returned array contains the following fields:

```php
[
    'meta_key' => 'overall_status',              // The field that was changed
    'gravatar' => 'https://gravatar.com/...',   // User's gravatar URL (or empty string)
    'name' => 'John Smith',                      // Display name of the user who made the change
    'object_note' => 'Overall Status: Active',  // Human-readable description of the change
    'hist_time' => 1627123456,                   // Unix timestamp of when the change occurred
    'meta_id' => 12345,                          // ID of the postmeta record
    'histid' => 67890,                           // ID of the activity log record
    'field_type' => 'key_select'                 // Type of field that was changed
]
```

## Field Type Examples

Below are examples of how different field types appear in activity messages. The `object_note` field contains the formatted message that is generated by the `format_activity_message()` function in `posts.php`.

### 1. Text Fields (`text`, `textarea`)

When a text field is updated:

```php
[
    'meta_key' => 'name',
    'gravatar' => 'https://gravatar.com/avatar/abc123',
    'name' => 'Admin User',
    'object_note' => 'Name changed to John Doe',
    'hist_time' => 1627123456,
    'meta_id' => 123,
    'histid' => 456,
    'field_type' => 'text'
]
```

### 2. Key Select Fields (`key_select`)

When a key select field is updated:

```php
[
    'meta_key' => 'overall_status',
    'gravatar' => 'https://gravatar.com/avatar/def456',
    'name' => 'Jane Smith',
    'object_note' => 'Overall Status: Active',
    'hist_time' => 1627123500,
    'meta_id' => 124,
    'histid' => 457,
    'field_type' => 'key_select'
]
```

### 3. Multi-Select Fields (`multi_select`)

When an option is added to a multi-select field:

```php
[
    'meta_key' => 'milestones',
    'gravatar' => 'https://gravatar.com/avatar/ghi789',
    'name' => 'Bob Johnson',
    'object_note' => 'Has Bible added to Milestones',
    'hist_time' => 1627123600,
    'meta_id' => 125,
    'histid' => 458,
    'field_type' => 'multi_select'
]
```

When an option is removed from a multi-select field:

```php
[
    'meta_key' => 'milestones',
    'gravatar' => 'https://gravatar.com/avatar/ghi789',
    'name' => 'Bob Johnson',
    'object_note' => 'Has Bible removed from Milestones',
    'hist_time' => 1627123700,
    'meta_id' => 126,
    'histid' => 459,
    'field_type' => 'multi_select'
]
```

### 4. Tags Fields (`tags`)

When a tag is added:

```php
[
    'meta_key' => 'tags',
    'gravatar' => 'https://gravatar.com/avatar/jkl012',
    'name' => 'Sarah Wilson',
    'object_note' => 'VIP added to Tags',
    'hist_time' => 1627123800,
    'meta_id' => 127,
    'histid' => 460,
    'field_type' => 'tags'
]
```

When a tag is removed:

```php
[
    'meta_key' => 'tags',
    'gravatar' => 'https://gravatar.com/avatar/jkl012',
    'name' => 'Sarah Wilson',
    'object_note' => 'VIP removed from Tags',
    'hist_time' => 1627123900,
    'meta_id' => 128,
    'histid' => 461,
    'field_type' => 'tags'
]
```

### 5. User Select Fields (`user_select`)

When a user is assigned:

```php
[
    'meta_key' => 'assigned_to',
    'gravatar' => 'https://gravatar.com/avatar/mno345',
    'name' => 'Mike Davis',
    'object_note' => 'Assigned to: John Smith',
    'hist_time' => 1627124000,
    'meta_id' => 129,
    'histid' => 462,
    'field_type' => 'user_select'
]
```

### 6. Boolean Fields (`boolean`)

When a boolean field is set to true:

```php
[
    'meta_key' => 'requires_update',
    'gravatar' => 'https://gravatar.com/avatar/pqr678',
    'name' => 'Lisa Brown',
    'object_note' => 'Requires Update: Yes',
    'hist_time' => 1627124100,
    'meta_id' => 130,
    'histid' => 463,
    'field_type' => 'boolean'
]
```

When a boolean field is set to false:

```php
[
    'meta_key' => 'requires_update',
    'gravatar' => 'https://gravatar.com/avatar/pqr678',
    'name' => 'Lisa Brown',
    'object_note' => 'Requires Update: No',
    'hist_time' => 1627124200,
    'meta_id' => 131,
    'histid' => 464,
    'field_type' => 'boolean'
]
```

### 7. Number Fields (`number`)

When a number field is updated:

```php
[
    'meta_key' => 'baptism_generation',
    'gravatar' => 'https://gravatar.com/avatar/stu901',
    'name' => 'Tom Wilson',
    'object_note' => 'Baptism Generation: 3',
    'hist_time' => 1627124300,
    'meta_id' => 132,
    'histid' => 465,
    'field_type' => 'number'
]
```

### 8. Date Fields (`date`, `datetime`)

When a date field is set:

```php
[
    'meta_key' => 'baptism_date',
    'gravatar' => 'https://gravatar.com/avatar/vwx234',
    'name' => 'Amy Johnson',
    'object_note' => 'Baptism Date: {1627123456}',
    'hist_time' => 1627124400,
    'meta_id' => 133,
    'histid' => 466,
    'field_type' => 'date'
]
```

When a date field is removed:

```php
[
    'meta_key' => 'baptism_date',
    'gravatar' => 'https://gravatar.com/avatar/vwx234',
    'name' => 'Amy Johnson',
    'object_note' => 'Baptism Date removed',
    'hist_time' => 1627124500,
    'meta_id' => 134,
    'histid' => 467,
    'field_type' => 'date'
]
```

### 9. Location Fields (`location`)

When a location is added:

```php
[
    'meta_key' => 'location_grid',
    'gravatar' => 'https://gravatar.com/avatar/yz0123',
    'name' => 'David Lee',
    'object_note' => 'United States added to locations',
    'hist_time' => 1627124600,
    'meta_id' => 135,
    'histid' => 468,
    'field_type' => 'location'
]
```

When a location is removed:

```php
[
    'meta_key' => 'location_grid',
    'gravatar' => 'https://gravatar.com/avatar/yz0123',
    'name' => 'David Lee',
    'object_note' => 'United States removed from locations',
    'hist_time' => 1627124700,
    'meta_id' => 136,
    'histid' => 469,
    'field_type' => 'location'
]
```

### 10. Location Meta Fields (`location_meta`)

When a location meta (address) is added:

```php
[
    'meta_key' => 'location_grid_meta',
    'gravatar' => 'https://gravatar.com/avatar/abc456',
    'name' => 'Carol White',
    'object_note' => '123 Main St, Anytown, USA added to locations',
    'hist_time' => 1627124800,
    'meta_id' => 137,
    'histid' => 470,
    'field_type' => 'location_meta'
]
```

### 11. Communication Channel Fields

When a phone number is added:

```php
[
    'meta_key' => 'contact_phone_abc',
    'gravatar' => 'https://gravatar.com/avatar/def789',
    'name' => 'Mark Thompson',
    'object_note' => 'Added Phone: +1-555-123-4567',
    'hist_time' => 1627124900,
    'meta_id' => 138,
    'histid' => 471,
    'field_type' => 'communication_channel'
]
```

When a phone number is updated:

```php
[
    'meta_key' => 'contact_phone_abc',
    'gravatar' => 'https://gravatar.com/avatar/def789',
    'name' => 'Mark Thompson',
    'object_note' => 'Updated Phone from +1-555-123-4567 to +1-555-987-6543',
    'hist_time' => 1627125000,
    'meta_id' => 139,
    'histid' => 472,
    'field_type' => 'communication_channel'
]
```

When a phone number is deleted:

```php
[
    'meta_key' => 'contact_phone_abc',
    'gravatar' => 'https://gravatar.com/avatar/def789',
    'name' => 'Mark Thompson',
    'object_note' => 'Deleted Phone: +1-555-987-6543',
    'hist_time' => 1627125100,
    'meta_id' => 140,
    'histid' => 473,
    'field_type' => 'communication_channel'
]
```

### 12. Connection Fields (`connection`)

When a connection is made (e.g., contact added to group):

```php
[
    'meta_key' => 'contacts_to_groups',
    'gravatar' => 'https://gravatar.com/avatar/ghi012',
    'name' => 'Jennifer Davis',
    'object_note' => '[Small Group Alpha](https://example.com/groups/123/) added to Groups',
    'hist_time' => 1627125200,
    'meta_id' => 141,
    'histid' => 474,
    'field_type' => 'connection'
]
```

When a connection is removed:

```php
[
    'meta_key' => 'contacts_to_groups',
    'gravatar' => 'https://gravatar.com/avatar/ghi012',
    'name' => 'Jennifer Davis',
    'object_note' => '[Small Group Alpha](https://example.com/groups/123/) removed from Groups',
    'hist_time' => 1627125300,
    'meta_id' => 142,
    'histid' => 475,
    'field_type' => 'connection'
]
```

### 13. Link Fields (`link`)

When a social media link is added:

```php
[
    'meta_key' => 'link_field_social_facebook',
    'gravatar' => 'https://gravatar.com/avatar/jkl345',
    'name' => 'Robert Martinez',
    'object_note' => 'https://facebook.com/johndoe added to Facebook links',
    'hist_time' => 1627125400,
    'meta_id' => 143,
    'histid' => 476,
    'field_type' => 'link'
]
```

When a social media link is removed:

```php
[
    'meta_key' => 'link_field_social_facebook',
    'gravatar' => 'https://gravatar.com/avatar/jkl345',
    'name' => 'Robert Martinez',
    'object_note' => 'https://facebook.com/johndoe removed from Facebook links',
    'hist_time' => 1627125500,
    'meta_id' => 144,
    'histid' => 477,
    'field_type' => 'link'
]
```

### 14. Assignment Actions

When a user accepts an assignment:

```php
[
    'meta_key' => '',
    'gravatar' => 'https://gravatar.com/avatar/mno678',
    'name' => 'John Smith',
    'object_note' => 'John Smith accepted assignment',
    'hist_time' => 1627125600,
    'meta_id' => 0,
    'histid' => 478,
    'field_type' => ''
]
```

When a user declines an assignment:

```php
[
    'meta_key' => '',
    'gravatar' => 'https://gravatar.com/avatar/mno678',
    'name' => 'John Smith',
    'object_note' => 'John Smith declined assignment',
    'hist_time' => 1627125700,
    'meta_id' => 0,
    'histid' => 479,
    'field_type' => ''
]
```

### 15. Sharing Actions

When a post is shared with a user:

```php
[
    'meta_key' => '',
    'gravatar' => 'https://gravatar.com/avatar/pqr901',
    'name' => 'Admin User',
    'object_note' => 'Shared with John Smith',
    'hist_time' => 1627125800,
    'meta_id' => 0,
    'histid' => 480,
    'field_type' => ''
]
```

When sharing is removed:

```php
[
    'meta_key' => '',
    'gravatar' => 'https://gravatar.com/avatar/pqr901',
    'name' => 'Admin User',
    'object_note' => 'Unshared with John Smith',
    'hist_time' => 1627125900,
    'meta_id' => 0,
    'histid' => 481,
    'field_type' => ''
]
```

### 16. System Actions

When a contact is created from demo data:

```php
[
    'meta_key' => '_sample',
    'gravatar' => '',
    'name' => 'D.T System',
    'object_note' => 'Created from Demo Plugin',
    'hist_time' => 1627126000,
    'meta_id' => 145,
    'histid' => 482,
    'field_type' => ''
]
```

## Special User Types

The activity log can show different types of users who made changes:

### Regular Users
- `name`: User's display name
- `gravatar`: User's gravatar URL

### Site Link Users (from connected sites)
- `name`: Title of the connected site
- `gravatar`: Empty string

### Magic Link Submissions
- `name`: "Magic Link Submission" (or localized equivalent)
- `gravatar`: Empty string

### Activity Revert Bot
- `name`: "Revert Bot" (or localized equivalent)
- `gravatar`: Empty string

### System Actions
- `name`: "D.T System" (or localized equivalent)
- `gravatar`: Empty string

## Usage Examples

### Basic Activity Retrieval

```php
// Get all activity for contact ID 123
$activity = DT_Posts::get_post_activity('contacts', 123);

if (!is_wp_error($activity)) {
    echo "Total activity records: " . $activity['total'] . "\n";

    foreach ($activity['activity'] as $record) {
        echo $record['name'] . ": " . $record['object_note'] . "\n";
        echo "Time: " . date('Y-m-d H:i:s', $record['hist_time']) . "\n\n";
    }
}
```

### Paginated Activity Retrieval

```php
// Get the first 10 activity records, starting from record 0
$activity = DT_Posts::get_post_activity('contacts', 123, [
    'offset' => 0,
    'number' => 10
]);

// Get the next 10 activity records
$activity_page_2 = DT_Posts::get_post_activity('contacts', 123, [
    'offset' => 10,
    'number' => 10
]);
```

## API Endpoint

This method is also available via REST API:

```
GET /wp-json/dt-posts/v2/{post_type}/{post_id}/activity
```

Query parameters:
- `offset`: Number of records to skip
- `number`: Maximum number of records to return

## Permissions

Users can only retrieve activity for posts they have permission to view. The method will return a WP_Error with status 403 if the user doesn't have the necessary permissions.

## Filtering

The activity log automatically excludes:
- Hidden fields (fields with `'hidden' => true` in their settings)
- Activity records without meaningful messages

## Notes

- Activity records are returned in reverse chronological order (newest first)
- The `object_note` field contains human-readable messages generated by the `format_activity_message()` function
- Connection activities include clickable links to the connected records in markdown format
- Timestamps are in Unix format and represent UTC time
- The `meta_key` field corresponds to the database field that was changed
- The `field_type` field indicates the type of field that was modified
