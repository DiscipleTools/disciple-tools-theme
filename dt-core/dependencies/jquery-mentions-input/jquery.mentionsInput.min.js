!function(e,t){var n=0,i={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},a={triggerChar:"@",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:function(){return'<div class="mentions-input-box"></div>'},autocompleteList:function(){return'<div class="mentions-autocomplete-list"></div>'},autocompleteListItem:function(e){return"<li data-ref-id="+e.id+" data-ref-type="+e.type+" data-display="+e.display+">"+e.content+"</li>"},autocompleteListItemAvatar:function(e){return"<img src="+e.avatar+" />"},autocompleteListItemIcon:function(e){return'<div class="icon"'+e.icon+"></div>"},mentionsOverlay:function(e){return'<div class="mentions"><div></div></div>'},mentionItemSyntax:function(e){return"@["+e.value+"]("+e.type+":"+e.id+")"},mentionItemHighlight:function(e){return"<strong><span>"+e.value+"</span></strong>"}}},o={htmlEncode:function(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):e},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},r=function(t){var r,s,l,c,d,u,p,f=[],g={},m=[],h="";function v(){var n=b();e.each(f,function(e,i){var a=t.templates.mentionItemSyntax(i);n=n.replace(new RegExp(o.regexpEncode(i.value),"g"),a)});var i=o.htmlEncode(n);e.each(f,function(n,a){var r=e.extend({},a,{value:o.htmlEncode(a.value)}),s=t.templates.mentionItemSyntax(r),l=t.templates.mentionItemHighlight(r);i=i.replace(new RegExp(o.regexpEncode(s),"g"),l)}),i=(i=i.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),s.data("messageText",n),s.trigger("updated"),u.find("div").html(i)}function x(){m=[]}function y(e){for(var n=b(),i=s[0].selectionStart,a=!1,r=!1,l=new RegExp("\\"+t.triggerChar+h,"gi");l.exec(n);)(!1===a||Math.abs(l.lastIndex-i)<a)&&(a=Math.abs(l.lastIndex-i),r=l.lastIndex);var c=r-h.length-1,d=r,u=n.substr(0,c),p=n.substr(d,n.length),g=(u+e.value).length+1;f.find(function(t){return t.id==e.id})||f.push(e),x(),h="",A();var m=u+"@"+e.value+" "+p;s.val(m),s.trigger("mention"),v(),s.focus(),o.setCaratPosition(s[0],g)}function b(){return e.trim(s.val())}function w(t){var n,i,a=e(this);return y(g[a.attr("data-uid")]),n=e(s).offset().top,i=e("body").offset().top,e(window).scrollTop()>n&&e(window).scrollTop(n-i),!1}function C(e){x()}function E(e){A()}function T(n){if(navigator.userAgent.toLowerCase().indexOf("android")>-1&&s.val().trim().length){let e=s.val()[s.val().trim().length-1];m.push(e)}var i;v(),i=b(),f=(f=f.filter(function(e){return!(!e.value||-1==i.indexOf(e.value))})).filter(Boolean);var a=m.lastIndexOf(t.triggerChar);a>-1&&(h=m.slice(a+1).join(""),h=o.rtrim(h),setTimeout(e.proxy(L,this,h),1))}function I(e){if(!(navigator.userAgent.toLowerCase().indexOf("android")>-1)&&e.keyCode!==i.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);m.push(t)}}function S(t){if(t.keyCode===i.LEFT||t.keyCode===i.RIGHT||t.keyCode===i.HOME||t.keyCode===i.END)return setTimeout(x,1),void(navigator.userAgent.indexOf("MSIE 9")>-1&&setTimeout(v,1));if(t.keyCode!==i.BACKSPACE){if(!c.is(":visible"))return!0;switch(t.keyCode){case i.UP:case i.DOWN:var n=null;return(n=t.keyCode===i.DOWN?p&&p.length?p.next():c.find("li").first():e(p).prev()).length&&R(n),!1;case i.RETURN:case i.TAB:if(p&&p.length)return p.trigger("mousedown"),!1}return!0}m=m.slice(0,-1+m.length)}function A(){p=null,c.empty().hide()}function R(e){e.addClass(t.classes.autoCompleteItemActive),e.siblings().removeClass(t.classes.autoCompleteItemActive),p=e}function k(i,a){if(c.show(),!t.allowRepeat){var r=e.map(f,function(e,t){return window.lodash.get(t,"value")});a=a.filter(function(e){return!r.includes(e.name)})}if(a.length){c.empty();var l=e("<ul>").appendTo(c).hide();e.each(a,function(a,r){var s,c,d=(c=n++,(s="mention_")?s+c:c);g[d]=e.extend({},r,{value:r.name});var u=e(t.templates.autocompleteListItem({id:o.htmlEncode(r.id),display:o.htmlEncode(r.name),type:o.htmlEncode(r.type),content:o.highlightTerm(o.htmlEncode(r.display?r.display:r.name),i)})).attr("data-uid",d);(0===a&&R(u),t.showAvatars)&&(r.avatar?e(t.templates.autocompleteListItemAvatar({avatar:r.avatar})):e(t.templates.autocompleteListItemIcon({icon:r.icon}))).prependTo(u);u=u.appendTo(l)}),c.show(),t.onCaret&&function(t,n){var i=t.css("position");if("absolute"==i){var a=function(t){var n,i,a,o,r,s,l,c,d,u,p;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=0,p=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;u<p;u++)l[r=c[u]]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),(o=document.createElement("span")).innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).position(),e(a).remove(),s}}(n),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",a.left),t.css("top",o+a.top);var r=n.offset().left+n.width(),s=t.offset().left+t.width();r<=s&&t.css("left",Math.abs(t.position().left-(s-r)))}else if("fixed"==i){var l=function(t){var n,i,a,o,r,s,l,c,d,u,p;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},u=0,p=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;u<p;u++)l[r=c[u]]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),(o=document.createElement("span")).innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).offset(),e(a).remove(),s}}(n),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",l.left+1e4),t.css("top",o+l.top)}}(c,s),l.show()}else A()}function L(e){"string"==typeof e&&e.length>=t.minChars?t.onDataRequest.call(this,"search",e,function(t){k(e,t)}):A()}function M(e){f=[];for(var n,i=o.htmlEncode(e),a=new RegExp("("+t.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),r=i;null!=(n=a.exec(i));)r=r.replace(n[0],n[1]+n[2]),f.push({id:n[4],type:n[3],value:n[2],trigger:n[1]});s.val(r),v()}return t=e.extend(!0,{},a,t),{init:function(n){"true"!==(s=e(r=n)).attr("data-mentions-input")&&(l=s.parent(),d=e(t.templates.wrapper()),s.wrapAll(d),d=l.find("> div.mentions-input-box"),s.attr("data-mentions-input","true"),s.bind("keydown",S),s.bind("keypress",I),s.bind("click",C),s.bind("blur",E),navigator.userAgent.indexOf("MSIE 8")>-1?s.bind("propertychange",T):s.bind("input",T),t.elastic&&s.elastic()),(c=e(t.templates.autocompleteList())).appendTo(d),c.delegate("li","mousedown",w),(u=e(t.templates.mentionsOverlay())).prependTo(d),M(t.defaultValue),t.prefillMention&&y(t.prefillMention)},val:function(t){e.isFunction(t)&&t.call(this,f.length?s.data("messageText"):b())},reset:function(){M()},destroy:function(){var n=function(e){e&&(e.remove(),delete e)};M(t.defaultValue),g={},m=[],f=[],s&&(s.unbind("propertychange",T),s.unbind("input",T),s.unbind("keydown",S),s.unbind("keypress",I),s.unbind("click",C),s.unbind("blur",E),n(s)),n(p),n(u),n(e(r))},reinit:function(){M(!1)},getMentions:function(t){e.isFunction(t)&&t.call(this,f)}}};e.fn.mentionsInput=function(t,n){var i=arguments;return"object"!=typeof t&&t||(n=t),this.each(function(){var a=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new r(n));return e.isFunction(a[t])?a[t].apply(this,Array.prototype.slice.call(i,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist"):a.init.call(this,this)})}}(jQuery);
